+++
title="linux 网络编程实战（一））| tcpip"
tags=["linux 网络编程"]
categories=["linux 网络编程"]
date="2020-05-08T21:00:00+08:00"
+++

## 2. 以太网帧格式
### 2.1 以太网的封装格式（RFC 894)
| 目的地址 6 | 源地址 6 | 类型 2 | 数据 [46 1500] | CRC 4 |
```
数据 长度至少46字节 最多1500字节 最大传输单元MTU / 路径 MTU
发送端：封装 打上对应层的协议
接收端：分用（解封）

```
#### 2.1.1 类型和数据分解
ip数据报（MTU)：  | 类型0800 | ip 数据报 [46 1500]   | 
ARP数据报： | 类型0806 | ARP 请求/应答 28  | PAD 18 |
RARP数据报：| 类型8035 | RARP 请求/应答 28  | PAD 18 |
 
#### 2.1.2 用于以太网的ARP请求或应答分组格式
| 以太网目的地址 6 | 以太网源目的地址 6 | 帧类型 2 | 硬件类型 2 | 协议类型 2 |硬件地址长度 | 协议地址长度|op|发送端以太网地址 | 发送端IP地址 | 目的以太网地址 | 目的IP地址 |

- 以太网首部： | 以太网目的地址 6 | 以太网源目的地址 6 | 帧类型 2 |
- 28字节ARP请求应答： | 硬件类型 2 | 协议类型 2 |硬件地址长度 | 协议地址长度|op| 发送端以太网地址 | 发送端IP地址 | 目的以太网地址 | 目的IP地址 |

## 3. ICMP 协议 （ip网络层）
用于传递差错信息、时间、回显、网络信息等控制数据
```
    ip地址解析mac地址失败回传给源端 发送ICMP协议
    ping 将数据封装成ICMP协议
```
### 3.1 ICMP报文在IP报文中的位置
|ip头部| ICMP报文 |
### 3.2 ICMP 报文的数据格式
|类型 8位 | 代码 8位| 校验和16位 |
### 3.3 类型和代码
|类型|代码|描述|查询|差错|
|:---:|:---:|:---:|:---:|:---:|
|0|0| 回显应答（ping 应答）|*||
|3|0| 网络不可达||*|
|...|...|...|...|...|

## 4. ARP 协议
- 映射IP地址到MAC地址
- ARP 缓存
```
地址解析过程：
1.ARP缓冲区中有映射地址
2.1 有 跳转到8
2.2 没有 发出广播请求包
3 每台机器都收到并打开上传到网络层
4 是否发送给自己吗？
5.1 不是 放弃
5.2 回复 ARP 请求
6 把源的mac 加入到ARP缓冲区中
7 源收到回复包，并往ARP缓存区中加入条目
8 Mac
9 源IP 按目标MAC 发送数据并等待回应
```
### 4.1 数据在网络中传输过程

## 5. RARP协议

## 6.网络层
### 6.1 IP数据报格式
### 6.2 ip首部网际校验和

```
IP首部（不含校验和）反码 + 0x1111 = 发送端校验和

IP首部 = IP首部（不含校验和） + 发送端校验和

IP首部（不含校验和）反码  + 发送端校验和反码 = 接收端校验和
```
### 6.3 路由表查看
```
route -n 
```
### 6.4 路由表搜索
- 搜索匹配的主机地址
- 搜索网络地址
- 搜索默认表项
### 6.4 路由过程
## 7.传输层
### 7.1 tcp
### 7.2 udp
- 无连接
- 不可靠
- UPD 更加高效
#### 7.2.1 UDP 报文格式
- UDP 数据在IP 数据的位置  
| IP头部（20字节）| UDP头部（8字节）| UDP数据 |
- UDP 数据格式      
|0-15            |   16-31          |       
|源端口号(16位)    | 目的端口号 （16位）| 
|UPD数据长度（16） | UPD校验和（16位）  |  
|          数据                     |