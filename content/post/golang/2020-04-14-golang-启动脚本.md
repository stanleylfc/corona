+++
title="go 实战（五）| go 编译和启动"
tags=["go"]
categories=["go"]
date="2020-04-21T21:00:00+08:00"
+++

## 1. 启动脚本

1.1 编译好的二进制
```
#!/bin/bash

SERVER="apiserver"
BASE_DIR=$PWD
INTERVAL=2

# 命令行参数，需要手动指定
ARGS=""

function start()
{
	if [ "`pgrep $SERVER -u $UID`" != "" ];then
		echo "$SERVER already running"
		exit 1
	fi

	nohup $BASE_DIR/$SERVER $ARGS  server &>/dev/null &

	echo "sleeping..." &&  sleep $INTERVAL

	# check status
	if [ "`pgrep $SERVER -u $UID`" == "" ];then
		echo "$SERVER start failed"
		exit 1
	fi
}

function status() 
{
	if [ "`pgrep $SERVER -u $UID`" != "" ];then
		echo $SERVER is running
	else
		echo $SERVER is not running
	fi
}

function stop() 
{
	if [ "`pgrep $SERVER -u $UID`" != "" ];then
		kill -9 `pgrep $SERVER -u $UID`
	fi

	echo "sleeping..." &&  sleep $INTERVAL

	if [ "`pgrep $SERVER -u $UID`" != "" ];then
		echo "$SERVER stop failed"
		exit 1
	fi
}

case "$1" in
	'start')
	start
	;;  
	'stop')
	stop
	;;  
	'status')
	status
	;;  
	'restart')
	stop && start
	;;  
	*)  
	echo "usage: $0 {start|stop|restart|status}"
	exit 1
	;;  
esac

```
# 1.2 ansible 部署
```
#!/bin/bash

BASE_DIR=$PWD

read -p "是否需要编译最新代码 Y/N: " -t 30 is_make

if [[ $is_make != "Y" ]]  && [[ $is_make != "N" ]]; then
  exit
fi

servers=("a" "b" "c"  "d" "e")
read -p "选择发布的服务器[1(a)|2(b)|3(c)|4(d)|5(e)]:" -t 30 dst

if [[ $dst < 1 || $dst > ${#servers[@]} ]]; then
  exit
fi

read -p "你选择的是否编译最新代码是:$is_make, 你选择发布的服务器是:${servers[$dst - 1]}。 是否继续(Y/N)" -t 30  sure
if [[ $sure != "Y" ]]; then
  exit
fi

set -e

if [[ $is_make == "Y" ]]; then
    if [[ $dst == 1 ]]; then
      git checkout develop
    else
      git checkout master
    fi

    git pull
    make
fi

case "${servers[$dst - 1]}" in
	'a')
	ansible-playbook $BASE_DIR/a.yml
	;;
  'b')
	ansible-playbook $BASE_DIR/b.yml
	;;
	'c')
	ansible-playbook $BASE_DIR/c.yml
	;;
	'd')
	ansible-playbook $BASE_DIR/d.yml
	;;
  'e')
  ansible-playbook $BASE_DIR/e.yml
  ;;
	*)
	exit 1
	;;
esac
```